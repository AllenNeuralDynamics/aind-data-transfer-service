<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>{% block title %} {% endblock %} AIND Data Transfer Service</title>
    <style>
    fieldset {
      display:inline
    }
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 75%;
    }

    td, th {
      border: 1px solid #dddddd;
      text-align: left;
      padding: 8px;
    }
    </style>
</head>
<body>
    <nav>
        <a href="/">Submit Jobs</a> |
        <a href="/jobs">Job Status</a> |
        <a href= "{{ upload_template_link }}" >Job Submit Template</a>
    </nav>
    <h2>Submit Jobs</h2>
        <div>
        <fieldset>
            <legend>Mail Notifications (optional)</legend><br>
            <div>
                <label for="email" title="Optionally provide an allen institute email address to receive upload job status notifications">Allen Institute email:</label>
                <input type="email" id="email" pattern=".+@alleninstitute\.org" size="30" placeholder="@alleninstitute.org" /><br><br>
            </div>
            <div>
                <input type="checkbox" id="begin" name="begin" />
                <label for="begin">BEGIN</label> |
                <input type="checkbox" id="end" name="end" />
                <label for="end">END</label> |
                <input type="checkbox" id="fail" name="fail" checked />
                <label for="fail">FAIL</label> |
                <input type="checkbox" id="requeue" name="requeue" />
                <label for="requeue">REQUEUE</label> |
                <input type="checkbox" id="all" name="all" />
                <label for="all">ALL</label>
            </div>
        </fieldset>
        </div><br><br>
    <form id="preview_form" method="post" enctype="multipart/form-data">
        <label for="file">Please select a .csv or .xlsx file:</label>
        <input type="file" id="file" name="file" accept=".csv,.xlsx"><br><br>
        <input type="submit" id="preview" value="preview"><br><br>
    </form>
    <button type="button" onclick="submitJobs()">Submit</button>
    <div id="message"></div><br>
    <div id="response"></div>
    <script>
        var jobs = []
        var parsing_errors = []
        $(function() {
            $("#preview_form").on("submit", function(e) {
                e.preventDefault();
                if ($("#file").prop("files").length != 1) {
                    alert("No file selected. Please attach a .csv or .xlsx file.");
                    return;
                } 
                if (![".csv", ".xlsx"].some(ext => $("#file").prop("files")[0].name.endsWith(ext))) {
                    alert("Invalid file type. Please attach a .csv or .xlsx file.");
                    return;
                }
                var formData = new FormData(this);
                $.ajax({
                    url: "/api/validate_csv",
                    type: "POST",
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    beforeSend: function() {
                        $("#message").html("sending...");
                    },
                    success: function(data) {
                        $("#message").html("Returned response.");
                        jobs = data["data"]["jobs"];
                        parsing_errors = []
                        let jobsLength = jobs.length;
                        var table = document.createElement('table'), tr, td, row, cell;
                        for (row = 0; row < jobsLength; row++) {
                            let job = JSON.parse(jobs[row]);
                            tr = document.createElement('tr');
                            td = document.createElement('td');
                            tr.appendChild(td);
                            td.innerHTML = job.s3_bucket;
                            td = document.createElement('td');
                            tr.appendChild(td);
                            td.innerHTML = job.platform.abbreviation;
                            td = document.createElement('td');
                            tr.appendChild(td);
                            td.innerHTML = job.subject_id;
                            td = document.createElement('td');
                            tr.appendChild(td);
                            td.innerHTML = job.acq_datetime;
                            td = document.createElement('td');
                            table.appendChild(tr);
                            let modalities = job.modalities;
                            let modalitiesLength = modalities.length;
                            for (mRow = 0; mRow < modalitiesLength; mRow++){
                                let modality = modalities[mRow]
                                tr = document.createElement('tr');
                                td = document.createElement('td');
                                tr.appendChild(td);
                                td = document.createElement('td');
                                tr.appendChild(td);
                                td.innerHTML = modality.modality.abbreviation;
                                td = document.createElement('td');
                                tr.appendChild(td);
                                td.innerHTML = modality.source;
                                td.setAttribute("colspan", "4");
                                table.appendChild(tr);
                            }
                        }
                        document.getElementById('response').appendChild(table);
                    },
                    error: function(data) {
                        jobs = []
                        parsing_errors = data.responseJSON["data"]["errors"]
                        $("#message").html("Returned error");
                        document.getElementById("response").innerHTML = "";
                        $("#response").html(parsing_errors);
                    }
                });
            });
        });
        submitJobs = function() {
            if(jobs.length > 0 && parsing_errors.length == 0){
                let mail_user = $("#email").val();
                let hpc_settings = {};
                if (mail_user !== "" && mail_user !== undefined) {
                    let mail_type = [];
                    hpc_settings["mail_user"] = mail_user;
                    hpc_settings["comment"] = mail_user;
                    if ($("#all").is(":checked")) {
                        mail_type = ["ALL"];
                    } else {
                        if ($("#begin").is(":checked")) {
                            mail_type.push("BEGIN");
                        };
                        if ($("#end").is(":checked")) {
                            mail_type.push("END");
                        };
                        if ($("#fail").is(":checked")) {
                            mail_type.push("FAIL");
                        };
                        if ($("#requeue").is(":checked")) {
                            mail_type.push("REQUEUE");
                        };
                    };
                    if (mail_type.length == 0) {
                        hpc_settings["mail_type"] = "NONE";
                    } else {
                        hpc_settings["mail_type"] = mail_type.join()
                    };
                };
                let hpc_jobs = []
                for (row = 0; row < jobs.length; row++) {
                    let job = jobs[row];
                    hpc_job = {"upload_job_settings": job, "hpc_settings": JSON.stringify(hpc_settings), "script": ""};
                    hpc_jobs.push(hpc_job);
                };
                $.ajax({
                    url: "/api/submit_hpc_jobs",
                    type: "POST",
                    data: JSON.stringify({"jobs": hpc_jobs}),
                    contentType: 'application/json; charset=utf-8',
                    beforeSend: function() {
                        $("#message").html("Submitting jobs. Please don't refresh or re-submit...");
                    },
                    success: function (data) {
                        jobs = []
                        parsing_errors = []
                        $("#message").html("Submitted Jobs.");
                        $("#response").html(data);
                    },
                    error: function(data) {
                        jobs = []
                        $("#message").html("Returned error");
                        document.getElementById("response").innerHTML = "";
                        parsing_errors = data.responseJSON["data"]["errors"]
                        $("#response").html(parsing_errors);
                    }
                });
            }
        };
    </script>
</body>
</html>
